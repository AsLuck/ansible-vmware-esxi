- name: Add ESXi host to vcenter
  hosts: all
  gather_facts: False
  become: no
  vars:
    datacenter: cloud
    folder: /cloud/testhost/host

  tasks:
    - name: add ESXi Host to vCenter under a specific folder
      vmware_host:
        hostname: "{{ lookup('env', 'VMWARE_HOST')|default(providers.vcenter.hostname) }}"
        username: "{{ lookup('env', 'VMWARE_USER')|default(providers.vcenter.username) }}"
        password: "{{ lookup('env', 'VMWARE_PASSWORD')|default(providers.vcenter.password) }}"
        datacenter_name: "{{ datacenter }}"
        folder: "{{ folder }}"
        esxi_hostname: '{{ ansible_host }}'
        esxi_username: '{{ ansible_user | default(ansible_ssh_user) }}'
        esxi_password: '{{ ansible_password }}'
        state: present
        add_connected: True
      delegate_to: localhost